<h3 align="center">Настройка API <img src="https://user-images.githubusercontent.com/5679180/79618120-0daffb80-80be-11ea-819e-d2b0fa904d07.gif" width="20px"></h3>

<p>
  <img src="https://github.com/burningmannn/YE_API/blob/main/img/1.png?raw=true"/>
  
  <h4>Качаем Django</h4>
  
  <img src="https://github.com/burningmannn/YE_API/blob/main/img/2.png?raw=true"/>
  
  <h4>Создаем файл <code>requirements.txt</code> и вносим туда данные:</h4>
  <pre>
asgiref==3.8.1
dj-database-url==2.2.0
Django==5.0.6
djangorestframework==3.15.2
essentials==1.1.5
gunicorn==22.0.0
packaging==24.1
psycopg2==2.9.9
psycopg2-binary==2.9.9
python-dotenv==1.0.1
sqlparse==0.5.0
typing_extensions==4.12.1
tzdata==2024.1
whitenoise==6.7.0
  </pre>

  <img src="https://github.com/burningmannn/YE_API/blob/main/img/3.png?raw=true"/>
  
  <h4>Обратите внимание:</h4>
  <p>С 8 и 9 строкой могут возникнуть проблемы в MacOS и Linux, поэтому необходимо установить PostgreSQL и добавить ссылки на эти библиотеки следующим образом:</p>
  <pre>
export PG_HOME=/Library/PostgreSQL/16
export PATH=$PATH:$PG_HOME/bin
  </pre>
  
  <p>Далее вводим команду:</p>
  <pre><code>pip install -r requirements.txt</code></pre>
  
  <img src="https://github.com/burningmannn/YE_API/blob/main/img/4.png?raw=true"/>
  
  <h4>Создаем проект:</h4>
  <pre><code>django-admin startproject API_JSON</code></pre>
  
  <p>Проверяем, что Django работает, перейдя в директорию проекта <code>API_JSON</code> и запустив его командой:</p>
  <pre><code>python manage.py runserver</code></pre>
  
  <h4>Удаляем дубликат папки и создаем приложение:</h4>
  <pre><code>python manage.py startapp APP</code></pre>
  
  <h4>Проект готов, осталось добавить базовые файлы (в любом порядке).</h4>
  
  <h4>Создаем <code>.gitignore</code> и добавляем туда данные:</h4>
  <pre>
# Django
*.pyc
__pycache__/
local_settings.py
db.sqlite3
media/
*.log
.env
# Virtual environment
venv/
# Editor directories and files
.vscode/
*.sublime-workspace
*.sublime-project
*.idea/
*.swp
*.swo
# Other
.DS_Store
  </pre>

  <h4>В Dockerfile записываем:</h4>
  <pre>
FROM python:3.12.3-slim-bullseye
WORKDIR /app
ENV PYTHONUNBUFFERED 1
ENV PYTHONDONTWRITEBYTECODE 1
COPY ./requirements.txt /app/
# install system dependencies
RUN apt-get update && apt-get install -y libpq-dev build-essential
# install dependencies
RUN pip install --upgrade pip && pip install --no-cache-dir -r requirements.txt
RUN mkdir staticfiles
COPY . /app
ENTRYPOINT ["gunicorn", "API_JSON.wsgi", "-b", "0.0.0.0:8000"]
  </pre>

  <p>Где FROM - подключение нужной версии Python, чтобы работали все зависимости через <code>requirements.txt</code>.</p>
  
  <h4>Далее создадим базу данных:</h4>
  <img src="https://github.com/burningmannn/YE_API/blob/main/img/5.png?raw=true"/>
  
  <p>Создаем <code>.env</code> файл, и там будут временные переменные, они скрыты от GitHub, чтобы не украли данные от БД:</p>
  <pre>
DATABASE_URL=''
# Берем данные из External Database URL
DEBUG=True
SECRET_KEY=''
# секрет ный ключ можно сделать рандомный
# ключи берем из данных на сайте
  </pre>

  <h4>Дальше заполним <code>settings.py</code>:</h4>
  <pre>
"""
Django settings for API_JSON project.
Generated by 'django-admin startproject' using Django 5.0.6.
For more information on this file, see
https://docs.djangoproject.com/en/5.0/topics/settings/
For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.0/ref/settings/
"""
import os, dj_database_url
from pathlib import Path
from dotenv import load_dotenv
load_dotenv()
BASE_DIR = Path(__file__).resolve().parent.parent
SECRET_KEY = os.getenv('SECRET_KEY', 'secret_key')
# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.getenv('DEBUG', 'False').lower() == 'true'
ALLOWED_HOSTS = [".onrender.com", '127.0.0.1']

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'APP',  # сюда пишем название приложения
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'API_JSON.urls'  # Пишем название проекта

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

DATABASES = {
    'default': dj_database_url.config(
        default=os.getenv('DATABASE_URL', 'Database URL not found'),
        conn_max_age=600
    )
}

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True
STATIC_URL = '/static/'

if not DEBUG:
    STATIC_ROOT = BASE_DIR / "staticfiles"
    STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
  </pre>

  <p>Проверяем БД с сайта в PostgreSQL:</p>
  <img src="https://github.com/burningmannn/YE_API/blob/main/img/6.png?raw=true"/>
  <img src="https://github.com/burningmannn/YE_API/blob/main/img/7.png?raw=true"/>

  <p>Не забыть добавить <code>.oregon-postgres.render.com</code> в название хоста.<br>
  Таблицы не создаем.<br>
  В <code>models.py</code> вставляем код модели (название таблиц должно быть «<code>*название приложения*_*название таблицы*</code>»).</p>

  <h4>Код для <code>models.py</code>:</h4>
  <pre>
from django.db import models

class Album(models.Model):
    name = models.CharField(max_length=100)
    image = models.ImageField(upload_to='albums/')
    URL_image = models.URLField(blank=True)

class Song(models.Model):
    name = models.CharField(max_length=100)
    image = models.ImageField(upload_to='songs/')
    URL_image = models.URLField(blank=True)
    artist = models.CharField(max_length=100)
    favorite = models.BooleanField(default=False)
    fileName = models.CharField(max_length=100)
    URL_music = models.URLField(blank=True)
    album = models.ForeignKey(Album, related_name='songs', on_delete=models.CASCADE)
  </pre>

  <h4>Код для <code>serializers.py</code>:</h4>
  <pre>
from rest_framework import serializers
from .models import Song, Album

class SongSerializer(serializers.Model ```python
Serializer):
    class Meta:
        model = Song
        fields = ['name', 'image', 'artist', 'favorite', 'fileName', 'URL_image', 'URL_music']

class AlbumSerializer(serializers.ModelSerializer):
    songs = SongSerializer(many=True)

    class Meta:
        model = Album
        fields = ['name', 'image', 'songs', 'URL_image']
  </pre>

  <h4>Код для <code>views.py</code> приложения APP:</h4>
  <pre>
from django.http import JsonResponse
from .models import Song
from .serializers import AlbumSerializer, SongSerializer

def get_song(request):
    songs = Song.objects.select_related('album').all()
    albums = {}
    favorites = {'name': 'Favorites', 'image': 'favorite', 'URL_image': '', 'songs': []}

    for song in songs:
        album_name = song.album.name
        album_image = song.album.image
        album_url_image = song.album.URL_image

        if album_name not in albums:
            albums[album_name] = {'name': album_name, 'image': album_image, 'URL_image': album_url_image, 'songs': []}

        albums[album_name]['songs'].append(SongSerializer(song).data)

        if song.favorite:
            favorites['songs'].append(SongSerializer(song).data)

    albums['Favorites'] = favorites
    serializer = AlbumSerializer(albums.values(), many=True)
    return JsonResponse(serializer.data, safe=False)
  </pre>

  <img src="https://github.com/burningmannn/YE_API/blob/main/img/8.png?raw=true"/>

  <h4>Настройка <code>urls.py</code>:</h4>
  <pre>
from django.contrib import admin
from django.urls import path
from APP import views  # Подключаем views в нашем приложении APP

urlpatterns = [
    # путь как мы будем обращаться к API
    # обращение к вьюшке, получение данных из этой функции
    path('api/songs/', views.get_song, name='get_song'),
]
  </pre>

  <p>После этого выполняем миграции:</p>
  <pre><code>python manage.py makemigrations</code></pre>

  <img src="https://github.com/burningmannn/YE_API/blob/main/img/9.png?raw=true"/>

  <pre><code>python manage.py migrate</code></pre>
 
  <p>Теперь добавляем данные в таблицы, используя файлы <code>album.csv</code> и <code>songs.csv</code>:</p>
  <pre>
# album.csv
"id","name","image","URL_image"
"1","Calm","calm",""
"2","Dark","dark",""
"3","Dramatic","dramatic",""
"4","Favorites","favorite",""
# songs.csv
"id","name","image","URL_image","artist","favorite","fileName","URL_music","album_id"
"1","Body And Attitude","2","","DJ Freedem",False,"Body And Attitude - DJ Freedem","","1"
"2","A Simple Feeling","4","","Alge",False,"A Simple Feeling - Alge","","2"
"3","Illusions","dark","","Anno Domini Beats",True,"Illusions - Anno Domini Beats","","2"
"4","Shadows","4","","Anno Domini Beats",False,"Shadows - Anno Domini Beats","","2"
"5","Feeling's Not Mutual","1","","Single Friend",True,"Feeling's Not Mutual - Single Friend","","3"
"6","Kalimba","dramatic","","Cxdy",True,"Kalimba - Cxdy","","3"
  </pre>

  <p>Запускаем сервер для проверки работы API:</p>
  <pre><code>python manage.py runserver</code></pre>

  <p>Теперь можно проверить работу API в браузере.</p>

  <p>Не забудьте запушить репозиторий и подключить его в Render.</p>

  <img src="https://github.com/burningmannn/YE_API/blob/main/img/10.png?raw=true"/>
  <img src="https://github.com/burningmannn/YE_API/blob/main/img/11.png?raw=true"/>

  <p>Сюда добавляем external</p>

  <img src="https://github.com/burningmannn/YE_API/blob/main/img/12.png?raw=true"/>

  <p>Теперь из db можно взять env</p>

  <img src="https://github.com/burningmannn/YE_API/blob/main/img/13.png?raw=true"/>
</p>